require 'albacore'

task :default => [:test]

DEFAULT_BUILD_NUMBER = "0.0.0"
COMPANY_NAME = "MVBA, P.C."
COPYRIGHT = "MVBA, P.C. (c) 2011"

desc "Create CommonAssemblyInfo.cs file"
assemblyinfo :assemblyinfo do |asm| 
  build_number = get_build_number
  build_number_with_hash = get_build_number_with_hash
  
  asm.version = build_number
  asm.file_version = build_number
  asm.trademark = build_number_with_hash
  asm.company_name = COMPANY_NAME
  asm.copyright = COPYRIGHT
  asm.output_file = "src/CommonAssemblyInfo.cs"
end

desc "Build"
msbuild :build => :assemblyinfo do |msb|
  msb.properties :configuration => :Debug
  msb.targets :Clean, :Build
  msb.solution = "src/StarterTree.sln"
end

desc "Test"
nunit :test => :build do |nunit|
  nunit.command = "tools/NUnit/bin/nunit-console.exe"
  #  nunit.options '/framework v4.0.30319'
  nunit.assemblies "src/StarterTree.Tests/bin/Debug/StarterTree.Tests.dll"
end


def get_build_number
  begin
    gittag = `git describe --long`.chomp # looks something like v0.1.0-63-g3f10c2e
    #puts "gittag: #{gittag}"
    parts = gittag.split("-")
    base_version = parts[0].gsub("v","")
    git_build_revision = parts[1]
    git_short_hash = parts[2]
    #puts "base_version: #{base_version}"
    #puts "git_build_revision: #{git_build_revision}"
    #puts "git_short_hash: #{git_short_hash}"
    build_number = "#{base_version}.#{git_build_revision}"	
  rescue
    build_number = DEFAULT_BUILD_NUMBER
  end
end

def get_build_number_with_hash
  begin
    gittag = `git describe --long`.chomp # looks something like v0.1.0-63-g3f10c2e
    #puts "gittag: #{gittag}"
    parts = gittag.split("-")
    base_version = parts[0].gsub("v","")
    git_build_revision = parts[1]
    git_short_hash = parts[2]
    #puts "base_version: #{base_version}"
    #puts "git_build_revision: #{git_build_revision}"
    #puts "git_short_hash: #{git_short_hash}"
    build_number_with_hash = "#{base_version}.#{git_build_revision}-#{git_short_hash}"	
  rescue
    build_number_with_hash = DEFAULT_BUILD_NUMBER
  end
end